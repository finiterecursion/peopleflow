{% extends "layout.html" %}
{% block networkbar %}{% endblock %}
{% block baseheadline %}Peopleflow -  HasGeek{% endblock %}
{% block headline %}
<h1>{{ event.title }}- Venue Signup. </h1> 
{% endblock %}
{% block content %}

<div class="row">
    <form class="well form-search form-horizontal">
    <input autofocus class="input-medium search-query" id="search" type="text" name="key" value=""/>
    <a href="{{ url_for('venue_signup', id=event.id) }}" class="pull-right btn btn-primary">New Participant</a>
    <strong id="count"></strong>                      
    </form>
</div>

<div id="tabs">
          <table class="table table-striped">
            <thead>
              <th>#</th>        
              <th>Ticket #</th>
              <th>Date</th>
              <th>Name</th>
              <th>Email</th>
              <th>Company</th>
              <th>Tshirt Size</th>
              <th>Action</th>   
            </thead>
            <tbody>
              {% for i, p in enumerate(participants) %}
                  <tr class="hidden">
                  <td>{{ i+1 }}</td>
                  <td>{{ p.ticket_number }}</td>
                  <td>{{ utc.localize(p.regdate).astimezone(tz).strftime('%Y-%m-%d %H:%M')|e }}</td>
                  <td><strong>{{ p.name|e }}</strong></td>
                  <td>{{ hideemail.sub('...@', p.email)|e }}</td>
                  <td>{{ p.company|e }}</td>
                  <td>{{ p.tshirt_size }}</td>
                  <td>
                    {%- if p.attended -%}
                      <a id="signout"  href="{{ url_for('event_signout', year=event.year, eventname=event.name, pid=p.id) }}" class="btn">Sign out</a>
                    {%- else -%}
                    <form id="attend{{ i }}" action="{{ url_for('event_signin', eventname=event.name, year=event.year) }}" method="POST">
                      <input type="hidden" name="id" value="{{ p.id }}"/>                      
                      <input id="nfc_id{{ i }}" class="btn btn-primary hidden" type="submit" name="nfc_id" value="" />
                      <input id="signin{{ i }}" class="btn" type="button" value="Sign in" />
                      <a id="signout{{ i }}"  href="{{ url_for('event_signout', year=event.year, eventname=event.name, pid=p.id) }}" class="btn hidden">Sign out</a>
                    </form>
                    {%- endif -%}
                  </td>
                </tr>
              {% else %}
                <tr>
                  <td><em>(No participants found)</em></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
{% endblock %}
{% block footerscripts %}
  <script type="text/javascript">

    {% for i,p in enumerate(participants) -%}
    $('input#signin{{ i }}').bind('click', function(){ 
        $.getJSON("http://127.0.0.1:8008/card_id.json?callback=?", timeout=3000,
          function(data){

            if(data['error'] || data['card_id'].length<8) {
              $('input#signin{{ i }}').addClass("btn-danger");
            }

            else {
            $('input#nfc_id{{ i }}').attr("value", data['card_id']);
            $('input#nfc_id{{ i }}').removeClass("hidden");
            $('input#signin{{ i }}').addClass("hidden");
            $('#search').focus();

          };

          });
        });
      {% endfor -%}

    $(function() {
              
      {% for i,p in enumerate(participants) -%}
        $("{{ '#attend%d' % i }}").ajaxForm({replaceTarget: true, success: function(responseText, statusText, xhr, $form) {
        if(responseText=="success") {
          $('input#nfc_id{{ i }}').addClass("hidden");
          $('a#signout{{ i }}').removeClass("hidden");

          $.post('http://127.0.0.1:8008/print/{{ p.name }}/@{{ p.twitter }}', function(data) {
          });


        }
        else{
            $('input#nfc_id{{ i }}').addClass("hidden");
          $('input#signin{{ i }}').removeClass("hidden");

              $('input#signin{{ i }}').addClass("btn-danger");
        };
        }


        });
      {% endfor -%}
    });

var list = [];
{% for p in participants %}
list.push("{{ p.name }}");
{%- endfor %}

jQuery.expr[':'].Contains = function(a, i, m) { 
  return jQuery(a).text().toUpperCase().indexOf(m[3].toUpperCase()) >= 0; 
};


$('input#search').autocomplete({
  search: function(event, ui) {
    var query=this.value;
    $('tr').addClass("hidden");
    $('tr:Contains("'+query+'")').removeClass("hidden");
   },
     select: function(event, ui) {
    var query=this.value;
    $('tr').addClass("hidden");
    $('tr:contains("'+query+'")').removeClass("hidden");
   }
});

(function poll(){
   setTimeout(function(){
      $.getJSON("/event/{{ event.id }}/count", function(data){
        if(data['signed']){
          $('#count').html(data['signed']+'/'+data['total']);
            }
        poll();
          }
        );
  }, 5000);
})();
  </script>
{% endblock %}

